-- Create stages_exploits table to track d√©fis/exploits completion per stage
CREATE TABLE IF NOT EXISTS public.stages_exploits (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    stage_id BIGINT NOT NULL REFERENCES public.stages(id) ON DELETE CASCADE,
    exploit_id TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'en_cours' CHECK (status IN ('en_cours', 'complete')),
    completed_at TIMESTAMP WITH TIME ZONE,
    preuves_url JSONB,
    UNIQUE(stage_id, exploit_id)
);

-- Enable Row Level Security
ALTER TABLE public.stages_exploits ENABLE ROW LEVEL SECURITY;

-- Create policies for public access (demo mode - adjust for production)
CREATE POLICY "Public access for select" ON public.stages_exploits 
    FOR SELECT USING (true);

CREATE POLICY "Public access for insert" ON public.stages_exploits 
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Public access for update" ON public.stages_exploits 
    FOR UPDATE USING (true);

CREATE POLICY "Public access for delete" ON public.stages_exploits 
    FOR DELETE USING (true);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_stages_exploits_stage_id 
    ON public.stages_exploits(stage_id);

CREATE INDEX IF NOT EXISTS idx_stages_exploits_exploit_id 
    ON public.stages_exploits(exploit_id);

